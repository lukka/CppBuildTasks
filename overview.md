This extension provides the tasks **'run-vcpkg'** and **'run-cmake'** to build C++ code on Azure DevOps pipelines. Take a look at examples in the [README.md](https://github.com/lukka/CppBuildTasks/blob/master/README.md) file. 

## The '**run-vcpkg**' task

It uses [Git](https://git-scm.com/) to fetch [vcpkg](https://github.com/microsoft/vcpkg), it builds it, then launches vcpkg to build the specified ports.
It sets `VCPKG_ROOT` environment/task variable, which could be reused by subsequent tasks (i.e. by 'run-cmake').

### Caching vcpkg's artifacts

The [CacheBeta task](https://docs.microsoft.com/en-us/azure/devops/pipelines/caching/?view=azure-devops) could be used to cache vcpkg's artifacts to minimize build time. Use the task to cache the entire ```$(Build.BinariesDirectory)/vcpkg``` directory. 

_Note:_ since ```buildtrees```, ```packages``` and ```download``` subdirectories must not be cached, they are excluded by the ```.artifactignore``` file generated by the vcpkg-run task.

The key provided to the CacheBeta task must uniquely identify the following:
  - the vcpkg source files;
  - the used triplet and the list of ports to be installed;
  - the platform and the toolset used when building ports;

The following sample [key](https://docs.microsoft.com/en-us/azure/devops/pipelines/caching/?view=azure-devops#task-configuration) should grant all of the above:

```yaml
key: "$(Agent.Name)" | "$(vcpkgGitCommitId)" | @$(Build.SourcesDirectory)/response_file_with_ports_and_triplet.txt
```

where:
  - the ```$(vcpkgGitCommitId)``` value must be uniquely identify the content of vcpkg   repository, the commit id SHA1 is a perfect fit; a branch name should not be used, as it does not uniquely identify the content of the vcpkg repository.
  - the response file contains the list of packages along with the triplet, e.g. ```sqlite3 --triplet x64-linux```.
  - ```$(Agent.Name)``` captures both the agent platform and (most of the cases) the toolset. The latter could be changed and the key will not change though in some cases, you might want to add more values in order to ensure the key is unique in your scenarios.

_Note:_ the key must be a one liner, it could be divided in segments with the pipe character, each non-path segment must be enclosed with double quotes. [[source]](https://github.com/microsoft/azure-pipelines-tasks/issues/10842#issuecomment-510600843)

Further improvements could be made to the run-vcpkg task in order to support the automatic retrieval of the commit id of the vcpkg repository when the latter is a submodule of the build repository. Contributions are welcome!

## The '**run-cmake**' task

The 'run-cmake' task works with CMakeLists.txt and [CMakeSettings.json](https://docs.microsoft.com/en-us/cpp/build/cmakesettings-reference?view=vs-2019).
It can leverage the previous execution of the 'run-vcpkg' task by using the `VCPKG_ROOT` environment/task variable to:

  - set the vcpkg's toolchain file if requested, located at `$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake`;
  - set the environment for the provided triplet when building with [msvc](https://docs.microsoft.com/en-us/cpp/build/reference/c-cpp-building-reference?view=vs-2019) on Windows (i.e. building in the environment created by launching `$VCPKG_ROOT/vcpkg env`); 
 
## Questions and Answers

### Why not one single task?

Because you could use vcpkg only without CMake. Or you could use CMake without vcpkg.

### Would creating an ad-hoc bash/powershell script be easier?

Absolutely! Anyone can use this task as an inspiration for writing their own scripts to suite specific needs.
The purpose of the tasks is to streamline and to simplify the usage of vcpkg and CMake on build servers.

## Please get the source and contribute

The software is provided as is, there is no warranty of any kind. All users are encouraged to get the [source code](https://github.com/lukka/CppBuildTasks) and improve the tasks with fixes and new features. 

## Tasks' Flowcharts

### The 'Run CMake" flowchart

The flowchart has two entry points as it could be used with a CMakeLists.txt or with a CMakeSettings.json file.


>  ![Run CMake task](task-cmake/docs/task-cmake.png)


### The 'Run vcpkg' flowchart


>  ![Run vcpkg task](task-vcpkg/docs/task-vcpkg.png)


